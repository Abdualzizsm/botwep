import os
import sys
import logging
import threading
from typing import Dict, Optional, Any

from telegram import Update
from telegram.constants import ParseMode
from telegram import InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import (
    Application, CommandHandler, MessageHandler, filters,
    CallbackQueryHandler, ContextTypes
)

# Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from config import BOT_TOKEN, DOWNLOAD_PATH, FILE_EXPIRY, MAX_FILE_SIZE, BASE_URL
from common.downloader import YouTubeDownloader
from bot.utils import (
    user_data_cache, format_video_info, create_format_keyboard,
    clean_user_data
)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ù…Ù„ YouTube
downloader = YouTubeDownloader(DOWNLOAD_PATH)

# Ù‚Ø§Ù…ÙˆØ³ Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø·Ø©
active_downloads = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø¡ /start.
    """
    user = update.effective_user
    welcome_message = (
        f"ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ {user.first_name}!\n\n"
        f"Ø£Ù†Ø§ Ø¨ÙˆØª ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨. ğŸ¬\n\n"
        f"ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„Ù‡ Ù„Ùƒ Ø¨Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙŠ ØªØ®ØªØ§Ø±Ù‡Ø§.\n\n"
        f"ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆÙŠØ¨: {BASE_URL}\n\n"
        f"Ø£Ø±Ø³Ù„ /help Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª."
    )
    
    await update.message.reply_text(welcome_message)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© /help.
    """
    help_text = (
        "ğŸ” *ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª:*\n\n"
        "1ï¸âƒ£ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨\n"
        "2ï¸âƒ£ Ø§Ø®ØªØ± Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ø¯ÙŠÙƒ\n"
        "3ï¸âƒ£ Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„ÙŠÙƒ\n\n"
        "ğŸ“Œ *Ø£ÙˆØ§Ù…Ø± Ø¥Ø¶Ø§ÙÙŠØ©:*\n"
        "/start - Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª\n"
        "/help - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©\n"
        "/cancel - Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©\n\n"
        "ğŸ”— *ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆÙŠØ¨:*\n"
        f"ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆÙŠØ¨: {BASE_URL}\n\n"
        "âš ï¸ *Ù…Ù„Ø§Ø­Ø¸Ø§Øª:*\n"
        "- Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ù‡Ùˆ 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª\n"
        "- Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© ÙˆÙ‚ØªÙ‹Ø§ Ø£Ø·ÙˆÙ„\n"
        "- Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡Øª Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§"
    )
    
    await update.message.reply_text(
        help_text,
        parse_mode=ParseMode.MARKDOWN
    )

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ /cancel.
    """
    user_id = update.effective_user.id
    
    # ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    clean_user_data(user_id)
    
    # Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø´Ø· Ø¥Ø°Ø§ ÙˆØ¬Ø¯
    if user_id in active_downloads:
        del active_downloads[user_id]
    
    await update.message.reply_text("âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.")

async def process_youtube_url(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø±Ø³Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
    """
    user_id = update.effective_user.id
    message_text = update.message.text
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡ÙŠ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨
    if not downloader.is_valid_youtube_url(message_text):
        await update.message.reply_text(
            "âŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ ØµØ§Ù„Ø­."
        )
        return
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"
    processing_message = await update.message.reply_text(
        "â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø·...",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("Ø¥Ù„ØºØ§Ø¡", callback_data="cancel")]
        ])
    )
    
    try:
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        video_info = downloader.get_video_info(message_text)
        
        if not video_info:
            await processing_message.edit_text(
                "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."
            )
            return
        
        # ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_data_cache[user_id] = {
            'url': message_text,
            'video_info': video_info,
            'page': 0
        }
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        message_text = format_video_info(video_info)
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        keyboard = create_format_keyboard(video_info)
        
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        await processing_message.edit_text(
            text=message_text,
            parse_mode=ParseMode.MARKDOWN,
            reply_markup=keyboard
        )
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨: {str(e)}")
        await processing_message.edit_text(
            f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø·: {str(e)}"
        )

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø¶Ù…Ù†Ø©.
    """
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    chat_id = update.effective_chat.id
    
    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø²Ø±
    data = query.data
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if user_id not in user_data_cache:
        await query.edit_message_text(text="âŒ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
        return
    
    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    user_data = user_data_cache[user_id]
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø²Ø±
    if data.startswith('format_'):
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
        format_id = data.replace('format_', '')
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        if 'video_info' not in user_data:
            await query.edit_message_text(text="âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
            return
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        video_info = user_data['video_info']
        url = user_data['url']
        
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        progress_message = await query.edit_message_text(
            text="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„ØªØ­Ù…ÙŠÙ„...",
            reply_markup=None
        )
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
        active_downloads[user_id] = {
            'url': url,
            'format_id': format_id,
            'format_type': 'video',
            'chat_id': chat_id,
            'message_id': progress_message.message_id
        }
        
        # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø®ÙŠØ· Ù…Ù†ÙØµÙ„
        threading.Thread(
            target=lambda: asyncio.run(download_and_send(
                context, user_id, url, format_id, 'video', 
                chat_id, progress_message.message_id
            ))
        ).start()
        
    elif data == 'audio':
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        if 'video_info' not in user_data:
            await query.edit_message_text(text="âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
            return
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        url = user_data['url']
        
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        progress_message = await query.edit_message_text(
            text="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„ØªØ­Ù…ÙŠÙ„...",
            reply_markup=None
        )
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
        active_downloads[user_id] = {
            'url': url,
            'format_id': 'best',
            'format_type': 'audio',
            'chat_id': chat_id,
            'message_id': progress_message.message_id
        }
        
        # Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø®ÙŠØ· Ù…Ù†ÙØµÙ„
        threading.Thread(
            target=lambda: asyncio.run(download_and_send(
                context, user_id, url, 'best', 'audio', 
                chat_id, progress_message.message_id
            ))
        ).start()
        
    elif data == 'cancel':
        # Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if user_id in active_downloads:
            # Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            del active_downloads[user_id]
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            await query.edit_message_text(text="âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ø¢Ø®Ø± Ù„Ù„ØªØ­Ù…ÙŠÙ„.")
        else:
            # ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            clean_user_data(user_id)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            await query.edit_message_text(text="âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©. Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ø¢Ø®Ø± Ù„Ù„ØªØ­Ù…ÙŠÙ„.")
    
    else:
        # Ø²Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ
        await query.edit_message_text(text="âŒ Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")

async def download_and_send(context: ContextTypes.DEFAULT_TYPE, user_id: int, url: str, format_id: str, 
                     format_type: str, chat_id: int, message_id: int):
    """
    ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….
    """
    try:
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¨Ø£Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù‚Ø¯ Ø¨Ø¯Ø£
        progress_message = f"â³ *Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...*\n\n" \
                          f"*Ø§Ù„Ø±Ø§Ø¨Ø·:* {url}\n" \
                          f"*Ø§Ù„Ù†ÙˆØ¹:* {format_type}\n"
        
        # ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
        await update_progress_message(context, chat_id, message_id, "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", 0, 100, 0)
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø§Ù„ØµÙˆØª
        if format_type == 'video':
            file_path = downloader.download_video(url, format_id, 
                                                 progress_callback=lambda progress, file_size, eta: 
                                                 update_progress_message(context, chat_id, message_id, 
                                                                               "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", 
                                                                               progress, file_size, eta))
        else:
            file_path = downloader.download_audio(url, 
                                                 progress_callback=lambda progress, file_size, eta: 
                                                 update_progress_message(context, chat_id, message_id, 
                                                                               "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", 
                                                                               progress, file_size, eta))
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù‚Ø¯ ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­
        if not file_path or not os.path.exists(file_path):
            await update_progress_message(context, chat_id, message_id, "ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„", 0, 0, 0)
            return
        
        # ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
        await update_progress_message(context, chat_id, message_id, "Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„", 100, 100, 0)
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
        file_size = os.path.getsize(file_path) / (1024 * 1024)  # Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ù„Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
        if file_size > MAX_FILE_SIZE:
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ±Ù‹Ø§ Ø¬Ø¯Ù‹Ø§ØŒ Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
            error_message = f"âš ï¸ *Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ØªÙ„ØºØ±Ø§Ù…*\n\n" \
                           f"Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: {file_size:.2f} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª\n" \
                           f"Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: {MAX_FILE_SIZE} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª\n\n" \
                           f"ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ:\n" \
                           f"{BASE_URL}/download?file={os.path.basename(file_path)}"
            
            await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=error_message,
                parse_mode=ParseMode.MARKDOWN
            )
            return
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
        if format_type == 'video':
            await context.bot.send_video(
                chat_id=chat_id,
                video=open(file_path, 'rb'),
                filename=os.path.basename(file_path),
                caption="ğŸ¬ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¨ÙˆØª ØªØ­Ù…ÙŠÙ„ ÙŠÙˆØªÙŠÙˆØ¨",
                parse_mode=ParseMode.MARKDOWN,
                supports_streaming=True
            )
        else:
            await context.bot.send_audio(
                chat_id=chat_id,
                audio=open(file_path, 'rb'),
                filename=os.path.basename(file_path),
                caption="ğŸµ ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¨ÙˆØª ØªØ­Ù…ÙŠÙ„ ÙŠÙˆØªÙŠÙˆØ¨",
                parse_mode=ParseMode.MARKDOWN
            )
        
        # Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
        await context.bot.delete_message(
            chat_id=chat_id,
            message_id=message_id
        )
        
        # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        try:
            os.remove(file_path)
        except:
            pass
        
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù: {str(e)}")
        try:
            await update_progress_message(context, chat_id, message_id, f"ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: {str(e)}", 0, 0, 0)
        except:
            pass

    finally:
        # ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        clean_user_data(user_id)
        
        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©
        if user_id in active_downloads:
            del active_downloads[user_id]

async def update_progress_message(context: ContextTypes.DEFAULT_TYPE, chat_id: int, message_id: int, 
                           status: str, downloaded: int, total: int, eta: int) -> None:
    """
    ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„.
    """
    try:
        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
        percentage = 0
        if total > 0:
            percentage = int((downloaded / total) * 100)
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        progress_bar = ""
        if percentage > 0:
            filled_length = int(20 * percentage // 100)
            progress_bar = "â–“" * filled_length + "â–‘" * (20 - filled_length)
        else:
            progress_bar = "â–‘" * 20
        
        # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ
        if status == "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„" and total > 0:
            # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø¥Ù„Ù‰ Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
            downloaded_mb = downloaded / (1024 * 1024)
            total_mb = total / (1024 * 1024)
            
            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
            eta_str = ""
            if eta > 0:
                minutes, seconds = divmod(eta, 60)
                eta_str = f"{minutes}:{seconds:02d}"
            
            text = (
                f"â³ *Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...*\n\n"
                f"*Ø§Ù„ØªÙ‚Ø¯Ù…:* {percentage}% ({downloaded_mb:.1f}/{total_mb:.1f} Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)\n"
                f"{progress_bar}\n"
                f"*Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:* {eta_str}"
            )
        elif status == "Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„":
            text = f"âœ… *ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!*\n\nØ¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù..."
        elif status == "ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„":
            text = f"âŒ *ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„*\n\n{downloaded}"
        else:
            text = f"â„¹ï¸ *Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„:* {status}"
        
        await context.bot.edit_message_text(
            chat_id=chat_id,
            message_id=message_id,
            text=text,
            parse_mode=ParseMode.MARKDOWN
        )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø¯Ù…: {str(e)}")

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.
    """
    logger.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {context.error}")
    
    try:
        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if update and update.effective_chat:
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text=f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {context.error}"
            )
    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ø·Ø£: {str(e)}")

async def cleanup_task(context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    Ù…Ù‡Ù…Ø© Ø¯ÙˆØ±ÙŠØ© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.
    """
    downloader.cleanup_old_files(FILE_EXPIRY)
    logger.info(f"ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£ÙƒØ«Ø± Ù…Ù† {FILE_EXPIRY} Ø³Ø§Ø¹Ø©)")

async def main():
    """
    Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª.
    """
    try:
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª
        application = Application.builder().token(BOT_TOKEN).build()
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±
        application.add_handler(CommandHandler("start", start))
        application.add_handler(CommandHandler("help", help_command))
        application.add_handler(CommandHandler("cancel", cancel))
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, process_youtube_url))
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        application.add_handler(CallbackQueryHandler(button_callback))
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        application.add_error_handler(error_handler)
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¯ÙˆØ±ÙŠØ© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        application.job_queue.run_repeating(cleanup_task, interval=3600, first=0)
        
        # Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
        logger.info("ØªÙ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª!")
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© run_polling Ù…Ø¹ ØªØ¹ÙŠÙŠÙ† drop_pending_updates=True Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ø§Ø±Ø¶Ø§Øª getUpdates
        await application.initialize()
        await application.start()
        await application.updater.start_polling(drop_pending_updates=True)
        
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª
        await application.updater.idle()
        
    except Exception as e:
        logger.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

if __name__ == '__main__':
    import asyncio
    asyncio.run(main())
